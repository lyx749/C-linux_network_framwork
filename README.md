# 项目概述

一个通用的linux tcp服务器框架，采用reactor模式，epoll的LT模式，支持高并发，并且自定义了数据包头部，解决tcp粘包问题，设置了消息码，可以通过设置消息码对应的业务逻辑，从而去解决多种业务逻辑，设置了多个计时器(包括心跳包计时器，延迟回收计时器，flood攻击计时器)，从而解决了大部分的服务器网络安全问题。

## 运行模式

学习nginx采用一个master线程和一个或者多个worker子进程，并且采用守护进程的方式运行，其中master进程只负责监视worker子进程的运行状态，而业务都是在worker子进程中进行。

## 业务处理

设置了线程池和连接池，线程池负责执行业务逻辑代码，连接池分为总连接池，待回收连接池，以及空闲连接池，设置了延迟回收机制，一般断开连接之后150秒之后再回收这个连接。

### 连接池

连接池有一个专门的线程对其进行回收，线程的基本工作原理就是，遍历整个待回收连接池，一旦里面的连接计时器到期，就将整个连接的资源进行释放，并且放到空闲连接池去。

### 收发包处理

#### 收包

```c++
//定义在http_macro.h中
#define _PKG_HD_INIT 0  //初始状态。准备接收数据包头
#define _PKG_HD_RECVING 1 //接收包头中，包头信息不完整，继续接受中
#define _PKG_BD_INIT 2 //包头信息接收完，准备接收包体
#define _PKG_BD_RECVING 3 //接收包体中，包体不完整，继续接收中，处理后直接返回到_PKG_HD_INIT_状态
```

设置了4个标志位，保证能够完整的收到数据包的所有内容。

并且收包过程中会在数据包的前面再加上一个消息头方便处理

```c++
typedef struct _STRUCT_MSG_HEADER
{
    http_connection_ptr pConn; // 记录对应的链接，注意这是一个指针
    uint64_t inCurrsequence;   // 收到数据包时记录对应连接的序号，将来能用于比较连接是否已经作废
} STRUCT_MSG_HEADER_T, *STRUCT_MSG_HEADER_PTR;
```

其中pConn是当前连接的指针，在连接结构体中也设置了inCurrsequence字段，当这个连接结构体每被用一次这个数就加1(包括回收，重新分配等等)，按照正常来说，消息头和连接结构体中这两个数应该是相同的，如果不同就代表这个连接出问题了，就应该立刻舍弃。

#### 发包

线程池的工作线程构建好数据包，放入待发送数据包的队列中，由发送数据包的线程统一发送。

### 业务逻辑处理

只是因为测试所需写了几个业务逻辑代码，具体都在CLogicSocket类中，以后想要写入更多的业务逻辑代码，都可以在这个类中进行完善。

发包我是采用的是开始不把socket可写事件通知加入epoll的红黑树节点，需要发送数据时，直接调用write和send发送，如果write或者send返回EAGIN(缓冲区满了，需要等待可写事件才能继续往发送缓冲区内写数据)，再把socket的写事件通知加入epoll的红黑树节点，这样变成了在epoll的驱动下发送数据，全部数据发送完毕之后，再把可写事件通知从epoll的红黑树节点中移除，这种方式的优点是，数据不多时可以避免epoll的红黑树节点中针对写事件通知的增删，提高了程序的执行效率。

## 进程相关

学习nginx采用一个master线程和一个或者多个worker子进程，这种做法灵活性是非常好的，因为业务主要是在worker进程中处理，所以worker进程出问题的概率最大，假设某个worker进程出现错误意外终止，此时master进程就会快速重新fork一个新的子进程，从而保证整个worker进程数量的稳定。



## 网络安全相关

在项目中考虑了很多与网络安全相关的：

1、最基本的就是僵尸连接，在这设置了心跳包的概念，就是每隔20秒必须发送一次心跳包，并且设置了是否立即踢人的选项可以在配置cmake文件中设置

2、还有flood攻击，就是在连续10次发送数据包的间隔都在100ms以内，那么就代表这个连接在攻击服务器，就进行踢除，上述选项也都可以在配置cmake文件中进行设置



## 项目概述

### src

#### include

专门存放各种头文件

#### app

保存的是修改进程名的代码

#### misc

包含线程池，内存分配类，以及crc加密解密类

#### proc

专门用于存放和进程处理有关的文件

#### logic

业务逻辑相关文件

#### net

网络相关文件

#### signal

信号处理相关文件

#### logs

日志相关文件(采用的是spdlog日志库)

#### http_parser

一个http报文解释器类



## 服务器框架性能

在1核cpu下，一个master进程，两个worker子进程，每个子进程包含120个线程，可以保持2048个连接连续不间断的收发包两个小时不断，(测试方式，ping服务器，如果可以ping通说明服务器没有达到饱和，反之则达到饱和，为了准确性进行多次测试)









